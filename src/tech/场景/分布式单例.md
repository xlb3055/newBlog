---
icon: pen-to-square
date: 2025-7-14
category:
- åç«¯
tag:
- Java
- é¢è¯•
- åœºæ™¯
---




# â˜ï¸ åˆ†å¸ƒå¼å•ä¾‹å¯¹è±¡æ€ä¹ˆå®ç°ï¼Ÿå½»åº•è®²é€ï¼Œåˆ«å†ä¸€çŸ¥åŠè§£ï¼

---

## ğŸ§© 1. ä»€ä¹ˆæ˜¯å•ä¾‹ï¼Ÿä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼å•ä¾‹ï¼Ÿ

æˆ‘ä»¬å…ˆè¯´è¯´\*\*å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰\*\*æ˜¯å¹²å˜›çš„ã€‚

ğŸ‘‰ åœ¨ Java é‡Œï¼Œæˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªç±»çš„å¯¹è±¡**åªå­˜åœ¨ä¸€ä»½å®ä¾‹**ï¼Œæ•´ä¸ªç¨‹åºéƒ½å…±äº«è¿™ä¸ªå¯¹è±¡ï¼Œè¿™å°±æ˜¯å•ä¾‹æ¨¡å¼ã€‚ä½ å¯èƒ½å†™è¿‡è¿™æ ·çš„ä»£ç ï¼š

```java
public class Singleton {
    private static final Singleton INSTANCE = new Singleton();
    public static Singleton getInstance() {
        return INSTANCE;
    }
}
```

è¿™æ˜¯â€œå•æœºå•è¿›ç¨‹å•ä¾‹â€ã€‚

---

## ğŸš¨ é—®é¢˜æ¥äº†

ç°åœ¨æˆ‘ä»¬æœ‰ä¸ªç³»ç»Ÿï¼Œéƒ¨ç½²åœ¨ **å¤šå°æœåŠ¡å™¨ä¸Šï¼Œæ¯å°æœåŠ¡å™¨ä¸€ä¸ª JVM è¿›ç¨‹**ï¼Œæ­¤æ—¶æ¯ä¸ª JVM éƒ½åˆ›å»ºäº† `Singleton.getInstance()`ã€‚ä½ è§‰å¾—ä½ åªåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶å®æœ‰ **N ä¸ªå¯¹è±¡**ï¼

æ‰€ä»¥è¿™æ—¶å€™è¦å®ç°â€œå…¨å±€å”¯ä¸€â€ï¼Œå¿…é¡»è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

### â“å¦‚ä½•åœ¨â€œå¤š JVMã€å¤šæœºå™¨â€çš„æƒ…å†µä¸‹ï¼Œä¿è¯ç³»ç»Ÿçº§åˆ«åªæœ‰ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Ÿ

---

## âœ… 2. åˆ†å¸ƒå¼å•ä¾‹çš„è®¾è®¡ç›®æ ‡

æˆ‘ä»¬å¸Œæœ›è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š

| åœºæ™¯          | è¦æ±‚                      |
| ----------- | ----------------------- |
| å¤šä¸ªè¿›ç¨‹éƒ¨ç½²åœ¨ä¸åŒæœºå™¨ | æ‰€æœ‰è¿›ç¨‹ä¹‹é—´åªèƒ½æœ‰ä¸€ä¸ªåœ¨åŒä¸€æ—¶é—´å†…æ‹¥æœ‰å•ä¾‹å¯¹è±¡ |
| å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯·æ±‚    | è°å…ˆè·å–æˆåŠŸï¼Œè°ç”¨ï¼Œåˆ«äººç­‰å¾…æˆ–æ”¾å¼ƒ       |
| ç³»ç»Ÿå´©æºƒæ¢å¤      | è¦èƒ½æ¢å¤å¯¹è±¡çŠ¶æ€æˆ–é‡æ–°æŠ¢å            |

è¿™ä¸ªé—®é¢˜å…¶å®ç­‰ä»·äºï¼š

> åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„ã€Œäº’æ–¥è®¿é—®ã€+ã€ŒçŠ¶æ€åŒæ­¥ã€

---

## ğŸ› ï¸ 3. å®ç°æ–¹æ¡ˆè¯¦è§£ï¼ˆæ¨è Redis å®ç° + æ•°æ®è½åœ°ï¼‰

### ğŸŒŸ æ•´ä½“æ€è·¯ï¼šä¸‰æ­¥èµ°

1. ç”¨ **Redis çš„åˆ†å¸ƒå¼é”**ï¼Œå®ç°â€œè°å…ˆæŠ¢åˆ°é”ï¼Œè°å…ˆç”¨å•ä¾‹å¯¹è±¡â€
2. æŠ¢åˆ°é”çš„èŠ‚ç‚¹ï¼Œä» Redis ä¸­è¯»å–å¯¹è±¡æ•°æ®ï¼ˆæˆ–è‡ªå·±åˆå§‹åŒ–ï¼‰ï¼Œç„¶åè¿”å›ä¸€ä¸ªå¯¹è±¡å®ä¾‹
3. ä½¿ç”¨å®Œå¯¹è±¡åï¼š**æ›´æ–°çŠ¶æ€å¹¶é‡Šæ”¾é”**

---

## ğŸ§± 4. è¯¦ç»†å®ç°æ­¥éª¤å’Œä»£ç ï¼ˆåŸºäº Redisï¼‰

æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªé”®ï¼š

* `singleton_lock`: ç”¨äºåŠ é”ï¼Œé˜²æ­¢å¤šè¿›ç¨‹åŒæ—¶åˆ›å»ºå¯¹è±¡
* `singleton_data`: å­˜å‚¨å¯¹è±¡æ•°æ®ï¼Œç”¨äºååºåˆ—åŒ–å‡ºå®ä¾‹

---

### ğŸ§ª Step 1ï¼šå°è¯•åŠ é”

æˆ‘ä»¬ä½¿ç”¨ Redis çš„ `SET key value NX EX` å‘½ä»¤ï¼Œå®ƒçš„æ„æ€æ˜¯ï¼š

* `NX`: å¦‚æœ key ä¸å­˜åœ¨æ‰ setï¼ˆåªå…è®¸ç¬¬ä¸€ä¸ªæŠ¢åˆ°ï¼‰
* `EX`: è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé¿å…é”æ­»ï¼‰
* value æ˜¯å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰ï¼Œé‡Šæ”¾æ—¶éªŒè¯ç”¨

ç¤ºä¾‹ä»£ç ï¼š

```java
String lockKey = "singleton_lock";
String lockVal = UUID.randomUUID().toString();
String result = jedis.set(lockKey, lockVal, "NX", "EX", 30);
if (!"OK".equals(result)) {
    return null; // æ²¡æŠ¢åˆ°é”ï¼Œæ”¾å¼ƒæˆ–é‡è¯•
}
```

---

### ğŸ§¬ Step 2ï¼šè¯»å–æˆ–æ„å»ºå•ä¾‹å¯¹è±¡

æˆ‘ä»¬å‡è®¾è¿™ä¸ªå¯¹è±¡æ˜¯ä¸ªé…ç½®ç±»ï¼š

```java
public class Config {
    private int maxThreads;
    private boolean safeMode;
    // getter / setter
}
```

æˆ‘ä»¬å…ˆçœ‹ Redis æ˜¯å¦å·²å­˜ï¼š

```java
String json = jedis.get("singleton_data");
Config cfg;

if (json != null) {
    cfg = JSON.parseObject(json, Config.class);
} else {
    cfg = new Config();
    cfg.setMaxThreads(32);
    cfg.setSafeMode(true);
}
```

---

### ğŸ§¼ Step 3ï¼šé‡Šæ”¾é” + æ›´æ–°çŠ¶æ€

Redis é”é‡Šæ”¾æ—¶æœ‰ä¸ªå‘ï¼š

ğŸ”´ ä¸èƒ½ç›´æ¥ `jedis.del(lockKey)`ï¼Œé˜²æ­¢è¯¯åˆ åˆ«äººçš„é”ï¼

âœ… æ­£ç¡®åšæ³•ï¼šLua è„šæœ¬æ£€æŸ¥ `value` æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå†åˆ 

```java
String lua = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
             "return redis.call('del', KEYS[1]) else return 0 end;";
jedis.eval(lua, Collections.singletonList(lockKey), Collections.singletonList(lockVal));
```

æœ€åï¼ŒæŠŠç”¨å®Œçš„å¯¹è±¡æŒä¹…åŒ–ï¼š

```java
jedis.set("singleton_data", JSON.toJSONString(cfg));
```

---

## ğŸ” æ€»ä½“æµç¨‹å›¾

```
Client A          Client B
   |                 |
   |   Redis SET NX  |   <-- åŠ é”
   |     æˆåŠŸ        |
   |   Redis GET     |   <-- è·å–å¯¹è±¡æ•°æ®
   |   Redis SET     |   <-- æ›´æ–°å¯¹è±¡çŠ¶æ€
   |   Lua è§£é”      |   <-- å®‰å…¨é‡Šæ”¾é”
   |                 |
```

---

## âœ… 5. ä¼˜åŠ¿æ€»ç»“

| ç»´åº¦  | ä¼˜åŠ¿               |
| --- | ---------------- |
| é«˜å¹¶å‘ | Redis åŸå­é”å¯ä¿è¯å¹¶å‘ç«äº‰ |
| ç®€å•æ€§ | æ— éœ€é¢å¤–éƒ¨ç½² ZK æˆ– etcd |
| æŒä¹…æ€§ | å¯¹è±¡æ•°æ®å¯è½ç›˜ï¼ˆJSON æ ¼å¼ï¼‰ |
| å®‰å…¨æ€§ | é”å¸¦å”¯ä¸€IDï¼Œé˜²æ­¢è¯¯åˆ       |

---

## âš ï¸ 6. æ³¨æ„äº‹é¡¹

* âš ï¸ åŠ é”å¿…é¡»å¸¦è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”
* âš ï¸ è§£é”å¿…é¡»ç”¨ Lua è„šæœ¬ï¼Œä¸èƒ½éšä¾¿åˆ  key
* âš ï¸ å¯¹è±¡å†…å®¹ä¸èƒ½å¤ªå¤§ï¼ˆé¿å… Redis å å†…å­˜ï¼‰
* âš ï¸ è‹¥è¦å¼ºä¸€è‡´æŒä¹…åŒ–ï¼Œåº”å®šæœŸå°† Redis è½ç›˜è‡³æ•°æ®åº“

---

## ğŸŒ 7. è¡¥å……æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

| æ–¹æ¡ˆ             | åœºæ™¯                              | ç¼ºç‚¹       |
| -------------- | ------------------------------- | -------- |
| æ•°æ®åº“è¡¨ + è¡Œé”      | å°æµé‡åœºæ™¯ï¼Œç›´æ¥ `SELECT FOR UPDATE` é”è¡¨ | æ€§èƒ½ä½      |
| ZooKeeper ä¸´æ—¶èŠ‚ç‚¹ | ä¼ä¸šé¡¹ç›®é«˜å¯ç”¨åœºæ™¯ï¼Œå¤©ç„¶åˆ†å¸ƒå¼é”æ”¯æŒ              | è¿ç»´å¤æ‚ï¼Œå†™æ³•é‡ |
| etcd CASæœºåˆ¶     | äº‘åŸç”Ÿã€K8s ç›¸å…³æœåŠ¡ä¸­ä½¿ç”¨å¤š                | ä¾èµ– etcd  |

---



