"use strict";(self.webpackChunkblog_road=self.webpackChunkblog_road||[]).push([[7551],{66262:(s,i)=>{i.A=(s,i)=>{const a=s.__vccOpts||s;for(const[s,e]of i)a[s]=e;return a}},28358:(s,i,a)=>{a.r(i),a.d(i,{comp:()=>t,data:()=>d});var e=a(20641);const n=[(0,e.Fv)('<hr><h1 id="claude-config-dir" tabindex="-1"><a class="header-anchor" href="#claude-config-dir"><span>CLAUDE_CONFIG_DIR</span></a></h1><h2 id="在单台服务器上通过-claude-config-dir-实现-claude-code-cli-多-agent-隔离-sdk-实战" tabindex="-1"><a class="header-anchor" href="#在单台服务器上通过-claude-config-dir-实现-claude-code-cli-多-agent-隔离-sdk-实战"><span>在单台服务器上通过 <code>CLAUDE_CONFIG_DIR</code> 实现 Claude Code CLI 多 Agent 隔离（SDK 实战）</span></a></h2><h2 id="目标读者" tabindex="-1"><a class="header-anchor" href="#目标读者"><span>目标读者</span></a></h2><ul><li>使用 <strong>Claude Code CLI</strong></li><li>使用 <strong>Claude Agent SDK（Python）</strong></li><li>希望在 <strong>同一台服务器</strong> 上运行 <strong>多个逻辑隔离的 Claude Agent</strong></li><li>每个 Agent 拥有 <strong>独立的完整配置（skills / settings / CLAUDE.md / 行为边界）</strong></li></ul><hr><h2 id="一、问题背景-为什么需要-多-agent-隔离" tabindex="-1"><a class="header-anchor" href="#一、问题背景-为什么需要-多-agent-隔离"><span>一、问题背景：为什么需要“多 Agent 隔离”</span></a></h2><p>在实际工程中，我们经常希望：</p><ul><li><p>Excel Agent：只处理 Excel 相关能力</p></li><li><p>Word Agent：只处理 Word 相关能力</p></li><li><p>每个 Agent：</p><ul><li>只暴露自己的配置目录（skills / CLAUDE.md / settings 等）</li><li>不共享 system prompt / CLAUDE.md / skill 集</li><li>不会“串技能”或误调用</li></ul></li></ul><p>但现实约束是：</p><ul><li>不希望每个 Agent 都单独一台服务器</li><li>希望 <strong>同一 FastAPI 服务 / 同一机器</strong> 上完成隔离</li></ul><hr><h2 id="二、claude-code-cli-的关键能力-claude-config-dir" tabindex="-1"><a class="header-anchor" href="#二、claude-code-cli-的关键能力-claude-config-dir"><span>二、Claude Code CLI 的关键能力：<code>CLAUDE_CONFIG_DIR</code></span></a></h2><p>Claude Code CLI 原生支持通过环境变量指定配置根目录：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CLAUDE_CONFIG_DIR</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/path/to/.claude-config</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>该目录下通常包含：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>.claude-config-xxx/</span></span>\n<span class="line"><span>├─ CLAUDE.md</span></span>\n<span class="line"><span>├─ settings.json</span></span>\n<span class="line"><span>└─ skills/</span></span>\n<span class="line"><span>   └─ &lt;skill_name&gt;/</span></span>\n<span class="line"><span>      ├─ SKILL.md</span></span>\n<span class="line"><span>      └─ settings.json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>核心事实：</strong></p><blockquote><p>Claude Code 在启动 Agent Runtime 时，只会从 <code>CLAUDE_CONFIG_DIR</code> 加载一次完整配置（含 CLAUDE.md / settings / skills）。</p></blockquote><p>这为“Agent 隔离”提供了天然的切入点。</p><hr><h2 id="三、整体方案设计-一句话版" tabindex="-1"><a class="header-anchor" href="#三、整体方案设计-一句话版"><span>三、整体方案设计（一句话版）</span></a></h2><blockquote><p><strong>通过 SDK 在创建 Claude Agent 时，传入不同的 <code>CLAUDE_CONFIG_DIR</code>，使 Claude Code CLI 在逻辑上变成不同的 Agent。</strong></p></blockquote><p>关键点：</p><ul><li>每个 Agent 对应一个 <strong>独立的 <code>.claude-config-*</code> 目录</strong></li><li>SDK 层通过 <code>env={&quot;CLAUDE_CONFIG_DIR&quot;: ...}</code> 注入</li><li>Claude Agent Runtime 只加载该目录下的完整配置</li><li>不会看到其他 Agent 的配置与 skill</li></ul><hr><h2 id="四、目录结构设计-实战示例" tabindex="-1"><a class="header-anchor" href="#四、目录结构设计-实战示例"><span>四、目录结构设计（实战示例）</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>agent/</span></span>\n<span class="line"><span>├─ .claude-config-excel</span></span>\n<span class="line"><span>│  └─ skills</span></span>\n<span class="line"><span>│     └─ excel</span></span>\n<span class="line"><span>│        ├─ SKILL.md</span></span>\n<span class="line"><span>│        └─ settings.json</span></span>\n<span class="line"><span>├─ .claude-config-word</span></span>\n<span class="line"><span>│  └─ skills</span></span>\n<span class="line"><span>│     └─ word</span></span>\n<span class="line"><span>│        ├─ SKILL.md</span></span>\n<span class="line"><span>│        └─ settings.json</span></span>\n<span class="line"><span>├─ .venv</span></span>\n<span class="line"><span>└─ chat.py</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="excel-skill-示例" tabindex="-1"><a class="header-anchor" href="#excel-skill-示例"><span>Excel Skill（示例）</span></a></h3><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" data-title="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Excel Skill</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">description</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Respond with a fixed marker to confirm the skill was invoked.</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">user-invocable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">When invoked, respond with exactly:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SKILL_EXCEL_OK</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Do not add any other text.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="word-skill-示例" tabindex="-1"><a class="header-anchor" href="#word-skill-示例"><span>Word Skill（示例）</span></a></h3><div class="language-markdown line-numbers-mode" data-highlighter="shiki" data-ext="markdown" data-title="markdown" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Word Skill</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">description</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Respond with a fixed marker to confirm the skill was invoked.</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">user-invocable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">---</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">When invoked, respond with exactly:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SKILL_WORD_OK</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Do not add any other text.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="五、fastapi-claude-agent-sdk-实现方式" tabindex="-1"><a class="header-anchor" href="#五、fastapi-claude-agent-sdk-实现方式"><span>五、FastAPI + Claude Agent SDK 实现方式</span></a></h2><h3 id="关键设计点" tabindex="-1"><a class="header-anchor" href="#关键设计点"><span>关键设计点</span></a></h3><ol><li><strong>每个请求可以传入自己的 <code>claude_config_dir</code></strong></li><li>SDK 创建 <code>ClaudeAgentOptions</code> 时注入 env</li><li>Claude Agent 从该目录加载 skills</li></ol><h3 id="核心代码-关键片段" tabindex="-1"><a class="header-anchor" href="#核心代码-关键片段"><span>核心代码（关键片段）</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">options_kwargs </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;system_prompt&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;You are a concise assistant.&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;setting_sources&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,),</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;cwd&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: payload.repo_root </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">or</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">Path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">__file__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).parent.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">resolve</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()),</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;allowed_tools&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [],</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> payload.claude_config_dir:</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    options_kwargs[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;env&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;CLAUDE_CONFIG_DIR&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: payload.claude_config_dir</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">options </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> ClaudeAgentOptions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(**options_kwargs)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="六、运行服务" tabindex="-1"><a class="header-anchor" href="#六、运行服务"><span>六、运行服务</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uvicorn</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> chat:app</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --host</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0.0.0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --port</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8000</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="七、验证隔离效果-关键实验" tabindex="-1"><a class="header-anchor" href="#七、验证隔离效果-关键实验"><span>七、验证隔离效果（关键实验）</span></a></h2><h3 id="_1️⃣-excel-agent" tabindex="-1"><a class="header-anchor" href="#_1️⃣-excel-agent"><span>1️⃣ Excel Agent</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -N</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -X</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> POST</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://127.0.0.1:8000/chat-stream</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;{</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;question&quot;: &quot;/excel&quot;,</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;claude_config_dir&quot;: &quot;/Users/xiaoxu/Desktop/agent/.claude-config-excel&quot;,</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;debug&quot;: true</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  }&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结果：</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>SKILL_EXCEL_OK</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_2️⃣-word-agent" tabindex="-1"><a class="header-anchor" href="#_2️⃣-word-agent"><span>2️⃣ Word Agent</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -N</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -X</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> POST</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://127.0.0.1:8000/chat-stream</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;{</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;question&quot;: &quot;/word&quot;,</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;claude_config_dir&quot;: &quot;/Users/xiaoxu/Desktop/agent/.claude-config-word&quot;,</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;debug&quot;: true</span></span>\n<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  }&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结果：</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>SKILL_WORD_OK</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_3️⃣-隔离验证-关键" tabindex="-1"><a class="header-anchor" href="#_3️⃣-隔离验证-关键"><span>3️⃣ 隔离验证（关键）</span></a></h3><ul><li>Excel Agent 调 <code>/word</code> → <strong>无输出 / 0 token</strong></li><li>Word Agent 调 <code>/excel</code> → <strong>无输出 / 0 token</strong></li></ul><p>说明：</p><blockquote><p>Claude Agent <strong>只加载了本次传入配置目录下的完整配置（含 CLAUDE.md / skills / settings）</strong>，不存在技能串扰。</p></blockquote><hr><h2 id="八、为什么这个方案-真的实现了隔离" tabindex="-1"><a class="header-anchor" href="#八、为什么这个方案-真的实现了隔离"><span>八、为什么这个方案“真的实现了隔离”</span></a></h2><h3 id="隔离发生在三个层级" tabindex="-1"><a class="header-anchor" href="#隔离发生在三个层级"><span>隔离发生在三个层级：</span></a></h3><h4 id="_1️⃣-配置层" tabindex="-1"><a class="header-anchor" href="#_1️⃣-配置层"><span>1️⃣ 配置层</span></a></h4><ul><li><code>CLAUDE_CONFIG_DIR</code> 不同</li><li>CLAUDE.md / settings / system 行为不同</li></ul><h4 id="_2️⃣-skill-发现层" tabindex="-1"><a class="header-anchor" href="#_2️⃣-skill-发现层"><span>2️⃣ Skill 发现层</span></a></h4><ul><li>Claude Code 只扫描该目录</li><li>其他 skill <strong>根本不存在于 runtime</strong></li></ul><h4 id="_3️⃣-调用层" tabindex="-1"><a class="header-anchor" href="#_3️⃣-调用层"><span>3️⃣ 调用层</span></a></h4><ul><li><code>/excel</code>、<code>/word</code> 只能在各自 Agent 生效</li><li>非法 command 被直接 short-circuit</li></ul><hr><h2 id="九、一个必须知道的重要限制-非常重要" tabindex="-1"><a class="header-anchor" href="#九、一个必须知道的重要限制-非常重要"><span>九、一个必须知道的重要限制（非常重要）</span></a></h2><h3 id="⚠️-claude-agent-runtime-是-进程级缓存的" tabindex="-1"><a class="header-anchor" href="#⚠️-claude-agent-runtime-是-进程级缓存的"><span>⚠️ Claude Agent Runtime 是 <strong>进程级缓存的</strong></span></a></h3><p>这意味着：</p><ul><li><p><strong><code>CLAUDE_CONFIG_DIR</code> 只在 Agent Runtime 首次初始化时生效</strong></p></li><li><p>在同一个 Python 进程中：</p><ul><li><strong>不能可靠地 per-request 切换 Agent</strong></li></ul></li></ul><h3 id="因此-本方案的正确使用姿势是" tabindex="-1"><a class="header-anchor" href="#因此-本方案的正确使用姿势是"><span>因此，本方案的正确使用姿势是：</span></a></h3><h4 id="✅-推荐方式" tabindex="-1"><a class="header-anchor" href="#✅-推荐方式"><span>✅ 推荐方式</span></a></h4><ul><li><p><strong>一个进程 = 一个 Agent</strong></p></li><li><p>或：</p><ul><li>Excel Agent 服务</li><li>Word Agent 服务</li></ul></li><li><p>共享机器，不共享 runtime</p></li></ul><h4 id="❌-不推荐方式" tabindex="-1"><a class="header-anchor" href="#❌-不推荐方式"><span>❌ 不推荐方式</span></a></h4><ul><li>同一进程内高频切换 config 目录</li><li>依赖 runtime reload（SDK 当前不支持）</li></ul><hr><h2 id="十、适用场景总结" tabindex="-1"><a class="header-anchor" href="#十、适用场景总结"><span>十、适用场景总结</span></a></h2><h3 id="适合" tabindex="-1"><a class="header-anchor" href="#适合"><span>适合：</span></a></h3><ul><li>单机多 Agent 部署</li><li>Agent 行为必须强隔离</li><li>企业内部工具 / 私有部署</li></ul><h3 id="不适合" tabindex="-1"><a class="header-anchor" href="#不适合"><span>不适合：</span></a></h3><ul><li>单进程高并发动态 Agent 切换</li><li>SaaS 级“用户自定义 Agent”</li></ul><hr><h2 id="十一、总结一句话" tabindex="-1"><a class="header-anchor" href="#十一、总结一句话"><span>十一、总结一句话</span></a></h2><blockquote><p><strong>通过 <code>CLAUDE_CONFIG_DIR</code> + Claude Agent SDK，可以在单台服务器上构建多个逻辑完全隔离的 Claude Code Agent，每个 Agent 拥有独立的 skills、配置与能力边界。</strong></p></blockquote><hr>',86)],l={},t=(0,a(66262).A)(l,[["render",function(s,i){return(0,e.uX)(),(0,e.CE)("div",null,n)}]]),d=JSON.parse('{"path":"/%E5%A5%B6%E5%A5%B6%E5%85%AB%E8%82%A1/%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A4%9Aagent%E9%9A%94%E7%A6%BB.html","title":"CLAUDE_CONFIG_DIR","lang":"zh-CN","frontmatter":{"icon":"pen-to-square","date":"2025-01-06T00:00:00.000Z","category":["后端"],"tag":["大模型"],"description":"CLAUDE_CONFIG_DIR 在单台服务器上通过 CLAUDE_CONFIG_DIR 实现 Claude Code CLI 多 Agent 隔离（SDK 实战） 目标读者 使用 Claude Code CLI 使用 Claude Agent SDK（Python） 希望在 同一台服务器 上运行 多个逻辑隔离的 Claude Agent 每个 Ag...","head":[["meta",{"property":"og:url","content":"https://xlb3055.github.io/newBlog/%E5%A5%B6%E5%A5%B6%E5%85%AB%E8%82%A1/%E5%A4%A7%E6%A8%A1%E5%9E%8B/%E5%A4%9Aagent%E9%9A%94%E7%A6%BB.html"}],["meta",{"property":"og:site_name","content":"Bin的技术博客"}],["meta",{"property":"og:title","content":"CLAUDE_CONFIG_DIR"}],["meta",{"property":"og:description","content":"CLAUDE_CONFIG_DIR 在单台服务器上通过 CLAUDE_CONFIG_DIR 实现 Claude Code CLI 多 Agent 隔离（SDK 实战） 目标读者 使用 Claude Code CLI 使用 Claude Agent SDK（Python） 希望在 同一台服务器 上运行 多个逻辑隔离的 Claude Agent 每个 Ag..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-21T09:06:17.000Z"}],["meta",{"property":"article:author","content":"Bin"}],["meta",{"property":"article:tag","content":"大模型"}],["meta",{"property":"article:published_time","content":"2025-01-06T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2026-01-21T09:06:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"CLAUDE_CONFIG_DIR\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-01-06T00:00:00.000Z\\",\\"dateModified\\":\\"2026-01-21T09:06:17.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Bin\\",\\"url\\":\\"/avator_img.jpg\\"}]}"]]},"headers":[{"level":2,"title":"在单台服务器上通过 CLAUDE_CONFIG_DIR 实现 Claude Code CLI 多 Agent 隔离（SDK 实战）","slug":"在单台服务器上通过-claude-config-dir-实现-claude-code-cli-多-agent-隔离-sdk-实战","link":"#在单台服务器上通过-claude-config-dir-实现-claude-code-cli-多-agent-隔离-sdk-实战","children":[]},{"level":2,"title":"目标读者","slug":"目标读者","link":"#目标读者","children":[]},{"level":2,"title":"一、问题背景：为什么需要“多 Agent 隔离”","slug":"一、问题背景-为什么需要-多-agent-隔离","link":"#一、问题背景-为什么需要-多-agent-隔离","children":[]},{"level":2,"title":"二、Claude Code CLI 的关键能力：CLAUDE_CONFIG_DIR","slug":"二、claude-code-cli-的关键能力-claude-config-dir","link":"#二、claude-code-cli-的关键能力-claude-config-dir","children":[]},{"level":2,"title":"三、整体方案设计（一句话版）","slug":"三、整体方案设计-一句话版","link":"#三、整体方案设计-一句话版","children":[]},{"level":2,"title":"四、目录结构设计（实战示例）","slug":"四、目录结构设计-实战示例","link":"#四、目录结构设计-实战示例","children":[{"level":3,"title":"Excel Skill（示例）","slug":"excel-skill-示例","link":"#excel-skill-示例","children":[]},{"level":3,"title":"Word Skill（示例）","slug":"word-skill-示例","link":"#word-skill-示例","children":[]}]},{"level":2,"title":"五、FastAPI + Claude Agent SDK 实现方式","slug":"五、fastapi-claude-agent-sdk-实现方式","link":"#五、fastapi-claude-agent-sdk-实现方式","children":[{"level":3,"title":"关键设计点","slug":"关键设计点","link":"#关键设计点","children":[]},{"level":3,"title":"核心代码（关键片段）","slug":"核心代码-关键片段","link":"#核心代码-关键片段","children":[]}]},{"level":2,"title":"六、运行服务","slug":"六、运行服务","link":"#六、运行服务","children":[]},{"level":2,"title":"七、验证隔离效果（关键实验）","slug":"七、验证隔离效果-关键实验","link":"#七、验证隔离效果-关键实验","children":[{"level":3,"title":"1️⃣ Excel Agent","slug":"_1️⃣-excel-agent","link":"#_1️⃣-excel-agent","children":[]},{"level":3,"title":"2️⃣ Word Agent","slug":"_2️⃣-word-agent","link":"#_2️⃣-word-agent","children":[]},{"level":3,"title":"3️⃣ 隔离验证（关键）","slug":"_3️⃣-隔离验证-关键","link":"#_3️⃣-隔离验证-关键","children":[]}]},{"level":2,"title":"八、为什么这个方案“真的实现了隔离”","slug":"八、为什么这个方案-真的实现了隔离","link":"#八、为什么这个方案-真的实现了隔离","children":[{"level":3,"title":"隔离发生在三个层级：","slug":"隔离发生在三个层级","link":"#隔离发生在三个层级","children":[]}]},{"level":2,"title":"九、一个必须知道的重要限制（非常重要）","slug":"九、一个必须知道的重要限制-非常重要","link":"#九、一个必须知道的重要限制-非常重要","children":[{"level":3,"title":"⚠️ Claude Agent Runtime 是 进程级缓存的","slug":"⚠️-claude-agent-runtime-是-进程级缓存的","link":"#⚠️-claude-agent-runtime-是-进程级缓存的","children":[]},{"level":3,"title":"因此，本方案的正确使用姿势是：","slug":"因此-本方案的正确使用姿势是","link":"#因此-本方案的正确使用姿势是","children":[]}]},{"level":2,"title":"十、适用场景总结","slug":"十、适用场景总结","link":"#十、适用场景总结","children":[{"level":3,"title":"适合：","slug":"适合","link":"#适合","children":[]},{"level":3,"title":"不适合：","slug":"不适合","link":"#不适合","children":[]}]},{"level":2,"title":"十一、总结一句话","slug":"十一、总结一句话","link":"#十一、总结一句话","children":[]}],"git":{"createdTime":1767683088000,"updatedTime":1768986377000,"contributors":[{"name":"bin","email":"13598151+binxlb@user.noreply.gitee.com","commits":3}]},"readingTime":{"minutes":3.5,"words":1050},"filePathRelative":"奶奶八股/大模型/多agent隔离.md","localizedDate":"2025年1月6日","excerpt":"<hr>\\n<h1>CLAUDE_CONFIG_DIR</h1>\\n<h2>在单台服务器上通过 <code>CLAUDE_CONFIG_DIR</code> 实现 Claude Code CLI 多 Agent 隔离（SDK 实战）</h2>\\n<h2>目标读者</h2>\\n<ul>\\n<li>使用 <strong>Claude Code CLI</strong></li>\\n<li>使用 <strong>Claude Agent SDK（Python）</strong></li>\\n<li>希望在 <strong>同一台服务器</strong> 上运行 <strong>多个逻辑隔离的 Claude Agent</strong></li>\\n<li>每个 Agent 拥有 <strong>独立的完整配置（skills / settings / CLAUDE.md / 行为边界）</strong></li>\\n</ul>","autoDesc":true}')}}]);