"use strict";(self.webpackChunkblog_road=self.webpackChunkblog_road||[]).push([[1316],{66262:(i,s)=>{s.A=(i,s)=>{const e=i.__vccOpts||i;for(const[i,a]of s)e[i]=a;return e}},81102:(i,s,e)=>{e.r(s),e.d(s,{comp:()=>t,data:()=>h});var a=e(20641);const l=[(0,a.Fv)('<hr><h1 id="外网开发访问内网服务-ssh-跳板-端口转发" tabindex="-1"><a class="header-anchor" href="#外网开发访问内网服务-ssh-跳板-端口转发"><span>外网开发访问内网服务（SSH 跳板 + 端口转发）</span></a></h1><hr><h2 id="_0-目标-我们要实现什么" tabindex="-1"><a class="header-anchor" href="#_0-目标-我们要实现什么"><span>0. 目标（我们要实现什么）</span></a></h2><p>我们的开发环境满足以下约束：</p><ul><li>我们人在 <strong>外网</strong>（家 / 咖啡店 / 热点）</li><li>外网 <strong>只能直连一台跳板机</strong></li><li>内网的 GitLab / Git / 数据库 / Redis / 各类后端服务 <strong>均不允许外网直连</strong></li></ul><p>通过 <strong>SSH 隧道（端口转发）</strong>，我们要实现：</p><ul><li>浏览器访问内网 GitLab → <code>https://localhost:PORT</code></li><li>Git clone / pull / push → <code>ssh://git@localhost:PORT/xxx.git</code></li><li>后端在<strong>本机启动</strong>，但能访问<strong>内网 DB / Redis / 依赖服务</strong> → <code>localhost:PORT</code></li></ul><hr><h2 id="_1-ssh-是什么-一句话" tabindex="-1"><a class="header-anchor" href="#_1-ssh-是什么-一句话"><span>1. SSH 是什么（一句话）</span></a></h2><blockquote><p><strong>SSH 是一种加密的远程连接协议，用来安全登录服务器，并建立加密隧道把远程服务“映射”到本机端口。</strong></p></blockquote><p>SSH 解决三件事：</p><ul><li><strong>加密</strong>：通信内容不可被窃听</li><li><strong>鉴权</strong>：证明“我们是谁”（用户 Key）</li><li><strong>身份校验</strong>：证明“我们连的是谁”（Host Key）</li></ul><hr><h2 id="_2-两种完全不同的-key-必须分清" tabindex="-1"><a class="header-anchor" href="#_2-两种完全不同的-key-必须分清"><span>2. 两种完全不同的 Key（必须分清）</span></a></h2><h3 id="_2-1-host-key-服务器的身份证" tabindex="-1"><a class="header-anchor" href="#_2-1-host-key-服务器的身份证"><span>2.1 Host Key（服务器的身份证）</span></a></h3><p><strong>什么时候见到？</strong></p><p>第一次执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2222</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git@localhost</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>会看到：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>The authenticity of host &#39;[localhost]:2222&#39; can&#39;t be established.</span></span>\n<span class="line"><span>ED25519 key fingerprint is SHA256:xxxx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>含义：</p><ul><li>这是 <strong>Git 服务器的 Host Key 指纹</strong></li><li>我们输入 <code>yes</code> 后，它会写入：</li></ul><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>~/.ssh/known_hosts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>作用：</p><ul><li>下次不再提示</li><li>防止中间人攻击</li></ul><hr><h3 id="_2-2-用户-key-我们的门禁卡" tabindex="-1"><a class="header-anchor" href="#_2-2-用户-key-我们的门禁卡"><span>2.2 用户 Key（我们的门禁卡）</span></a></h3><p>我们本机的一对密钥：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>~/.ssh/id_ed25519      （私钥，不能外泄）</span></span>\n<span class="line"><span>~/.ssh/id_ed25519.pub  （公钥）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>流程：</p><ol><li><strong>公钥</strong>加到 GitLab（用户设置 → SSH Keys）</li><li>GitLab 以后通过它识别我们的身份</li></ol><p>验证成功的标志：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -T</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2222</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git@localhost</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>返回：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Welcome to GitLab, @your_name!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_3-什么是跳板机-为什么需要它" tabindex="-1"><a class="header-anchor" href="#_3-什么是跳板机-为什么需要它"><span>3. 什么是跳板机，为什么需要它</span></a></h2><ul><li>内网资源 <strong>不对外暴露</strong></li><li>跳板机是 <strong>唯一允许外网 SSH 连接的入口</strong></li><li>我们 <strong>先连跳板机</strong></li><li>再让跳板机 <strong>代我们访问内网服务</strong></li></ul><p>逻辑结构：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>我们本机</span></span>\n<span class="line"><span>  |</span></span>\n<span class="line"><span>  |  SSH</span></span>\n<span class="line"><span>  v</span></span>\n<span class="line"><span>跳板机</span></span>\n<span class="line"><span>  |</span></span>\n<span class="line"><span>  |  内网访问</span></span>\n<span class="line"><span>  v</span></span>\n<span class="line"><span>GitLab / DB / Redis / 服务</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_4-端口转发-port-forwarding-是什么" tabindex="-1"><a class="header-anchor" href="#_4-端口转发-port-forwarding-是什么"><span>4. 端口转发（Port Forwarding）是什么</span></a></h2><p>我们使用的是：<strong>SSH 本地端口转发（-L）</strong></p><h3 id="一句话理解" tabindex="-1"><a class="header-anchor" href="#一句话理解"><span>一句话理解</span></a></h3><blockquote><p>把“内网的某个服务端口”，映射成“我们本机的 localhost:端口”。</p></blockquote><hr><h3 id="标准语法" tabindex="-1"><a class="header-anchor" href="#标准语法"><span>标准语法</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -L</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">本地端</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">口&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">内网主</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">机&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">内网端</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">口&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">user@jump_host</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="示例-git-ssh" tabindex="-1"><a class="header-anchor" href="#示例-git-ssh"><span>示例（Git SSH）</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -L</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2222:git.internal.example.com:22</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> user@jump_host</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>含义：</p><ul><li><p>本机监听 <code>localhost:2222</code></p></li><li><p>所有流量：</p><ul><li>加密 → 跳板机</li><li>再转发 → 内网 Git 的 22 端口</li></ul></li></ul><p>所以：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2222</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git@localhost</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>本质是在连内网 Git</strong></p><hr><h2 id="_5-转发脚本在做什么-拆解-魔法" tabindex="-1"><a class="header-anchor" href="#_5-转发脚本在做什么-拆解-魔法"><span>5. 转发脚本在做什么（拆解“魔法”）</span></a></h2><p>示例转发配置（脱敏）：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>本机端口   → 内网目标</span></span>\n<span class="line"><span>--------------------------------</span></span>\n<span class="line"><span>2222      → git.internal:22</span></span>\n<span class="line"><span>10443     → git.internal:443</span></span>\n<span class="line"><span>20030     → db.internal:20030</span></span>\n<span class="line"><span>6301      → redis.internal:6301</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>脚本通常还会做这些增强（推荐）：</p><ul><li>启动前检查端口是否已监听</li><li>SSH 掉线自动重连</li><li>写 PID / 日志，方便 stop</li><li>ServerAliveInterval 防止“假死连接”</li></ul><hr><h2 id="_6-外网访问内网-gitlab-网页" tabindex="-1"><a class="header-anchor" href="#_6-外网访问内网-gitlab-网页"><span>6. 外网访问内网 GitLab（网页）</span></a></h2><h3 id="_6-1-https-转发原理" tabindex="-1"><a class="header-anchor" href="#_6-1-https-转发原理"><span>6.1 HTTPS 转发原理</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>localhost:10443 → git.internal:443</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所以我们可以访问：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>https://localhost:10443</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_6-2-为什么浏览器能打开-idea-有时不行" tabindex="-1"><a class="header-anchor" href="#_6-2-为什么浏览器能打开-idea-有时不行"><span>6.2 为什么浏览器能打开，IDEA 有时不行</span></a></h3><p>原因：<strong>证书校验</strong></p><ul><li>证书签发给：<code>git.internal.example.com</code></li><li>我们访问的是：<code>https://localhost:10443</code></li></ul><p>浏览器：</p><ul><li>允许我们“忽略风险继续访问”</li></ul><p>IDEA / 某些客户端：</p><ul><li>校验证书更严格 → 可能拒绝</li></ul><h4 id="推荐解决方案-仅本机" tabindex="-1"><a class="header-anchor" href="#推荐解决方案-仅本机"><span>推荐解决方案（仅本机）</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>/etc/hosts</span></span>\n<span class="line"><span>127.0.0.1 git.internal.example.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后用：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>https://git.internal.example.com:10443</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_7-外网拉代码-git-clone-pull-push" tabindex="-1"><a class="header-anchor" href="#_7-外网拉代码-git-clone-pull-push"><span>7. 外网拉代码（Git clone / pull / push）</span></a></h2><h3 id="_7-1-确认隧道正常" tabindex="-1"><a class="header-anchor" href="#_7-1-确认隧道正常"><span>7.1 确认隧道正常</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -T</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2222</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git@localhost</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h3 id="_7-2-把公钥加到-gitlab" tabindex="-1"><a class="header-anchor" href="#_7-2-把公钥加到-gitlab"><span>7.2 把公钥加到 GitLab</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ~/.ssh/id_ed25519.pub</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>复制 → GitLab → 用户设置 → SSH Keys → Add</p><hr><h3 id="_7-3-使用正确的仓库地址" tabindex="-1"><a class="header-anchor" href="#_7-3-使用正确的仓库地址"><span>7.3 使用正确的仓库地址</span></a></h3><p><strong>原内网地址（不可用）：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>git@git.internal.example.com:group/project.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>外网通过转发使用：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>ssh://git@localhost:2222/group/project.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="新克隆" tabindex="-1"><a class="header-anchor" href="#新克隆"><span>新克隆</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> clone</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ssh://git@localhost:2222/group/project.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="已有仓库" tabindex="-1"><a class="header-anchor" href="#已有仓库"><span>已有仓库</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> remote</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set-url</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> origin</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ssh://git@localhost:2222/group/project.git</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pull</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --rebase</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_8-为什么之前会提示输入密码" tabindex="-1"><a class="header-anchor" href="#_8-为什么之前会提示输入密码"><span>8. 为什么之前会提示输入密码</span></a></h2><p>原因只有一个：</p><blockquote><p><strong>GitLab 没接受我们的公钥</strong></p></blockquote><p>SSH 流程是：</p><ol><li>尝试 publickey</li><li>失败 → 回退到 password</li></ol><p>解决：</p><ul><li>确认公钥已加</li><li>用下面命令强制验证：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -T</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2222</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> IdentitiesOnly=yes</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git@localhost</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_9-idea-中如何图形化更新项目" tabindex="-1"><a class="header-anchor" href="#_9-idea-中如何图形化更新项目"><span>9. IDEA 中如何图形化更新项目</span></a></h2><h3 id="_9-1-修改远端" tabindex="-1"><a class="header-anchor" href="#_9-1-修改远端"><span>9.1 修改远端</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Git → 管理远程 → origin</span></span>\n<span class="line"><span>ssh://git@localhost:2222/group/project.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_9-2-使用系统-ssh-推荐" tabindex="-1"><a class="header-anchor" href="#_9-2-使用系统-ssh-推荐"><span>9.2 使用系统 SSH（推荐）</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>设置 → 版本控制 → Git</span></span>\n<span class="line"><span>SSH 可执行文件：原生</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这样 IDEA 会使用：</p><ul><li>~/.ssh/config</li><li>~/.ssh/id_ed25519</li><li>ssh-agent</li></ul><hr><h2 id="_10-gitlab-集成-mr-issues-说明" tabindex="-1"><a class="header-anchor" href="#_10-gitlab-集成-mr-issues-说明"><span>10. GitLab 集成（MR / Issues）说明</span></a></h2><p>这是 <strong>GitLab API 集成</strong>，不是 git 拉代码必须的。</p><p>要成功：</p><ul><li><p>使用 <strong>Personal Access Token (PAT)</strong></p></li><li><p>勾选 scope：</p><ul><li><code>api</code></li><li><code>read_user</code></li></ul></li><li><p>服务地址需证书可接受（见第 6 节）</p></li></ul><p>不做 MR / Issues，可完全忽略此功能。</p><hr><h2 id="_11-后端在外网如何跑" tabindex="-1"><a class="header-anchor" href="#_11-后端在外网如何跑"><span>11. 后端在外网如何跑</span></a></h2><p>核心思想：</p><blockquote><p><strong>服务跑在我们本机，依赖“伪装成”本地端口。</strong></p></blockquote><h3 id="示例依赖映射" tabindex="-1"><a class="header-anchor" href="#示例依赖映射"><span>示例依赖映射</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>localhost:20030 → 内网 PostgreSQL</span></span>\n<span class="line"><span>localhost:6301  → 内网 Redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="后端配置示例" tabindex="-1"><a class="header-anchor" href="#后端配置示例"><span>后端配置示例</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">127.0.0.1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20030</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">redis</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">127.0.0.1</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6301</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="启动" tabindex="-1"><a class="header-anchor" href="#启动"><span>启动</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> APP_CONFIG</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">etc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">local</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">conf</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">python</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wsgi.py</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> server</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">python</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wsgi.py</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> worker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_12-前端在外网的通用思路" tabindex="-1"><a class="header-anchor" href="#_12-前端在外网的通用思路"><span>12. 前端在外网的通用思路</span></a></h2><ul><li>前端本地启动（npm / pnpm / yarn）</li><li>API Base URL 指向本机后端：</li></ul><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" data-title="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>http://localhost:5010</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>若需直连内网服务：</p><ul><li>同样通过 SSH 转发映射为 localhost</li></ul></li></ul><hr><h2 id="_13-常见问题速查表" tabindex="-1"><a class="header-anchor" href="#_13-常见问题速查表"><span>13. 常见问题速查表</span></a></h2><table><thead><tr><th>现象</th><th>原因</th><th>解决</th></tr></thead><tbody><tr><td>Are you sure you want to continue connecting</td><td>Host Key 校验</td><td>输入 yes</td></tr><tr><td>Permission denied (publickey)</td><td>公钥未加</td><td>加 SSH Key</td></tr><tr><td>一直要密码</td><td>key 未生效</td><td>ssh -T 验证</td></tr><tr><td>HOST IDENTIFICATION HAS CHANGED</td><td>known_hosts 冲突</td><td>ssh-keygen -R</td></tr><tr><td>IDEA 拉代码 OK，GitLab 集成失败</td><td>PAT / 证书问题</td><td>不影响 git</td></tr></tbody></table><hr><h2 id="总结一句话" tabindex="-1"><a class="header-anchor" href="#总结一句话"><span>总结一句话</span></a></h2><blockquote><p><strong>我们只连跳板机一次，用 SSH 把整个内网“折叠”成 localhost。</strong></p></blockquote><hr><h2 id="工程里的关键补充点" tabindex="-1"><a class="header-anchor" href="#工程里的关键补充点"><span>工程里的关键补充点</span></a></h2><h3 id="安全与合规边界" tabindex="-1"><a class="header-anchor" href="#安全与合规边界"><span>安全与合规边界</span></a></h3><ul><li>只转发必要端口，避免把内网全量暴露</li><li>跳板机权限最小化，避免一人权限即全网权限</li></ul><h3 id="稳定性与可维护" tabindex="-1"><a class="header-anchor" href="#稳定性与可维护"><span>稳定性与可维护</span></a></h3><ul><li>自动重连要有退避策略，避免断线风暴</li><li>脚本日志要有轮转，避免磁盘占满</li></ul><h3 id="证书与域名" tabindex="-1"><a class="header-anchor" href="#证书与域名"><span>证书与域名</span></a></h3><ul><li>浏览器可忽略证书风险，但客户端不一定允许</li><li>本地 hosts 映射要谨慎维护，避免污染真实域名</li></ul><h3 id="性能与排障" tabindex="-1"><a class="header-anchor" href="#性能与排障"><span>性能与排障</span></a></h3><ul><li>本地端口冲突是最常见问题，先检查占用进程</li><li>出现卡顿时先看跳板机负载与带宽</li></ul>',154)],n={},t=(0,e(66262).A)(n,[["render",function(i,s){return(0,a.uX)(),(0,a.CE)("div",null,l)}]]),h=JSON.parse('{"path":"/tech/%E5%9C%BA%E6%99%AF/%E5%A4%96%E7%BD%91%E5%BC%80%E5%8F%91%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1.html","title":"外网开发访问内网服务（SSH 跳板 + 端口转发）","lang":"zh-CN","frontmatter":{"icon":"pen-to-square","date":"2025-01-14T00:00:00.000Z","category":["后端"],"tag":["实战场景"],"description":"外网开发访问内网服务（SSH 跳板 + 端口转发） 0. 目标（我们要实现什么） 我们的开发环境满足以下约束： 我们人在 外网（家 / 咖啡店 / 热点） 外网 只能直连一台跳板机 内网的 GitLab / Git / 数据库 / Redis / 各类后端服务 均不允许外网直连 通过 SSH 隧道（端口转发），我们要实现： 浏览器访问内网 GitLab...","head":[["meta",{"property":"og:url","content":"https://xlb3055.github.io/newBlog/tech/%E5%9C%BA%E6%99%AF/%E5%A4%96%E7%BD%91%E5%BC%80%E5%8F%91%E8%AE%BF%E9%97%AE%E5%86%85%E7%BD%91%E6%9C%8D%E5%8A%A1.html"}],["meta",{"property":"og:site_name","content":"Bin的技术博客"}],["meta",{"property":"og:title","content":"外网开发访问内网服务（SSH 跳板 + 端口转发）"}],["meta",{"property":"og:description","content":"外网开发访问内网服务（SSH 跳板 + 端口转发） 0. 目标（我们要实现什么） 我们的开发环境满足以下约束： 我们人在 外网（家 / 咖啡店 / 热点） 外网 只能直连一台跳板机 内网的 GitLab / Git / 数据库 / Redis / 各类后端服务 均不允许外网直连 通过 SSH 隧道（端口转发），我们要实现： 浏览器访问内网 GitLab..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-21T09:06:17.000Z"}],["meta",{"property":"article:author","content":"Bin"}],["meta",{"property":"article:tag","content":"实战场景"}],["meta",{"property":"article:published_time","content":"2025-01-14T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2026-01-21T09:06:17.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"外网开发访问内网服务（SSH 跳板 + 端口转发）\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-01-14T00:00:00.000Z\\",\\"dateModified\\":\\"2026-01-21T09:06:17.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Bin\\",\\"url\\":\\"/avator_img.jpg\\"}]}"]]},"headers":[{"level":2,"title":"0. 目标（我们要实现什么）","slug":"_0-目标-我们要实现什么","link":"#_0-目标-我们要实现什么","children":[]},{"level":2,"title":"1. SSH 是什么（一句话）","slug":"_1-ssh-是什么-一句话","link":"#_1-ssh-是什么-一句话","children":[]},{"level":2,"title":"2. 两种完全不同的 Key（必须分清）","slug":"_2-两种完全不同的-key-必须分清","link":"#_2-两种完全不同的-key-必须分清","children":[{"level":3,"title":"2.1 Host Key（服务器的身份证）","slug":"_2-1-host-key-服务器的身份证","link":"#_2-1-host-key-服务器的身份证","children":[]},{"level":3,"title":"2.2 用户 Key（我们的门禁卡）","slug":"_2-2-用户-key-我们的门禁卡","link":"#_2-2-用户-key-我们的门禁卡","children":[]}]},{"level":2,"title":"3. 什么是跳板机，为什么需要它","slug":"_3-什么是跳板机-为什么需要它","link":"#_3-什么是跳板机-为什么需要它","children":[]},{"level":2,"title":"4. 端口转发（Port Forwarding）是什么","slug":"_4-端口转发-port-forwarding-是什么","link":"#_4-端口转发-port-forwarding-是什么","children":[{"level":3,"title":"一句话理解","slug":"一句话理解","link":"#一句话理解","children":[]},{"level":3,"title":"标准语法","slug":"标准语法","link":"#标准语法","children":[]},{"level":3,"title":"示例（Git SSH）","slug":"示例-git-ssh","link":"#示例-git-ssh","children":[]}]},{"level":2,"title":"5. 转发脚本在做什么（拆解“魔法”）","slug":"_5-转发脚本在做什么-拆解-魔法","link":"#_5-转发脚本在做什么-拆解-魔法","children":[]},{"level":2,"title":"6. 外网访问内网 GitLab（网页）","slug":"_6-外网访问内网-gitlab-网页","link":"#_6-外网访问内网-gitlab-网页","children":[{"level":3,"title":"6.1 HTTPS 转发原理","slug":"_6-1-https-转发原理","link":"#_6-1-https-转发原理","children":[]},{"level":3,"title":"6.2 为什么浏览器能打开，IDEA 有时不行","slug":"_6-2-为什么浏览器能打开-idea-有时不行","link":"#_6-2-为什么浏览器能打开-idea-有时不行","children":[]}]},{"level":2,"title":"7. 外网拉代码（Git clone / pull / push）","slug":"_7-外网拉代码-git-clone-pull-push","link":"#_7-外网拉代码-git-clone-pull-push","children":[{"level":3,"title":"7.1 确认隧道正常","slug":"_7-1-确认隧道正常","link":"#_7-1-确认隧道正常","children":[]},{"level":3,"title":"7.2 把公钥加到 GitLab","slug":"_7-2-把公钥加到-gitlab","link":"#_7-2-把公钥加到-gitlab","children":[]},{"level":3,"title":"7.3 使用正确的仓库地址","slug":"_7-3-使用正确的仓库地址","link":"#_7-3-使用正确的仓库地址","children":[]}]},{"level":2,"title":"8. 为什么之前会提示输入密码","slug":"_8-为什么之前会提示输入密码","link":"#_8-为什么之前会提示输入密码","children":[]},{"level":2,"title":"9. IDEA 中如何图形化更新项目","slug":"_9-idea-中如何图形化更新项目","link":"#_9-idea-中如何图形化更新项目","children":[{"level":3,"title":"9.1 修改远端","slug":"_9-1-修改远端","link":"#_9-1-修改远端","children":[]},{"level":3,"title":"9.2 使用系统 SSH（推荐）","slug":"_9-2-使用系统-ssh-推荐","link":"#_9-2-使用系统-ssh-推荐","children":[]}]},{"level":2,"title":"10. GitLab 集成（MR / Issues）说明","slug":"_10-gitlab-集成-mr-issues-说明","link":"#_10-gitlab-集成-mr-issues-说明","children":[]},{"level":2,"title":"11. 后端在外网如何跑","slug":"_11-后端在外网如何跑","link":"#_11-后端在外网如何跑","children":[{"level":3,"title":"示例依赖映射","slug":"示例依赖映射","link":"#示例依赖映射","children":[]},{"level":3,"title":"后端配置示例","slug":"后端配置示例","link":"#后端配置示例","children":[]},{"level":3,"title":"启动","slug":"启动","link":"#启动","children":[]}]},{"level":2,"title":"12. 前端在外网的通用思路","slug":"_12-前端在外网的通用思路","link":"#_12-前端在外网的通用思路","children":[]},{"level":2,"title":"13. 常见问题速查表","slug":"_13-常见问题速查表","link":"#_13-常见问题速查表","children":[]},{"level":2,"title":"总结一句话","slug":"总结一句话","link":"#总结一句话","children":[]},{"level":2,"title":"工程里的关键补充点","slug":"工程里的关键补充点","link":"#工程里的关键补充点","children":[{"level":3,"title":"安全与合规边界","slug":"安全与合规边界","link":"#安全与合规边界","children":[]},{"level":3,"title":"稳定性与可维护","slug":"稳定性与可维护","link":"#稳定性与可维护","children":[]},{"level":3,"title":"证书与域名","slug":"证书与域名","link":"#证书与域名","children":[]},{"level":3,"title":"性能与排障","slug":"性能与排障","link":"#性能与排障","children":[]}]}],"git":{"createdTime":1768361611000,"updatedTime":1768986377000,"contributors":[{"name":"bin","email":"13598151+binxlb@user.noreply.gitee.com","commits":3}]},"readingTime":{"minutes":5.19,"words":1557},"filePathRelative":"tech/场景/外网开发访问内网服务.md","localizedDate":"2025年1月14日","excerpt":"<hr>\\n<h1>外网开发访问内网服务（SSH 跳板 + 端口转发）</h1>\\n<hr>\\n<h2>0. 目标（我们要实现什么）</h2>\\n<p>我们的开发环境满足以下约束：</p>\\n<ul>\\n<li>我们人在 <strong>外网</strong>（家 / 咖啡店 / 热点）</li>\\n<li>外网 <strong>只能直连一台跳板机</strong></li>\\n<li>内网的 GitLab / Git / 数据库 / Redis / 各类后端服务 <strong>均不允许外网直连</strong></li>\\n</ul>\\n<p>通过 <strong>SSH 隧道（端口转发）</strong>，我们要实现：</p>","autoDesc":true}')}}]);